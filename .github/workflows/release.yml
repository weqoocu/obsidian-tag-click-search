name: Release Obsidian Plugin

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get version name
        id: version_name
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "VERSION_NAME=v${VERSION}" >> $GITHUB_OUTPUT

      - name: Create Release Notes
        id: release_notes
        run: |
          # å¦‚æžœå­˜åœ¨ç‰ˆæœ¬ç‰¹å®šçš„ release notesï¼Œä½¿ç”¨å®ƒ
          if [ -f "RELEASE_NOTES_${{ steps.version_name.outputs.VERSION_NAME }}.md" ]; then
            cat "RELEASE_NOTES_${{ steps.version_name.outputs.VERSION_NAME }}.md" > release_notes.md
          else
            # å¦åˆ™ä»Ž CHANGELOG.md æå–å¯¹åº”ç‰ˆæœ¬çš„å†…å®¹
            if [ -f "CHANGELOG.md" ]; then
              # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
              sed -n "/## \[${{ steps.get_version.outputs.VERSION }}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
              # å¦‚æžœæå–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
              if [ ! -s release_notes.md ]; then
                echo "## ðŸ”§ æ›´æ–°" > release_notes.md
                echo "" >> release_notes.md
                echo "æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> release_notes.md
              fi
            else
              echo "## ðŸ”§ æ›´æ–°" > release_notes.md
              echo "" >> release_notes.md
              echo "æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> release_notes.md
            fi
          fi
          
          # æ·»åŠ å®‰è£…è¯´æ˜Ž
          echo "" >> release_notes.md
          echo "## ðŸ“¦ å®‰è£…æ–¹æ³•" >> release_notes.md
          echo "" >> release_notes.md
          echo "### æ‰‹åŠ¨å®‰è£…" >> release_notes.md
          echo "1. ä¸‹è½½ä¸‹æ–¹çš„ \`main.js\` å’Œ \`manifest.json\`" >> release_notes.md
          echo "2. å¤åˆ¶åˆ° \`.obsidian/plugins/tag-click-search/\` ç›®å½•" >> release_notes.md
          echo "3. åœ¨ Obsidian è®¾ç½®ä¸­å¯ç”¨æ’ä»¶" >> release_notes.md
          echo "" >> release_notes.md
          echo "### é€šè¿‡ BRAT" >> release_notes.md
          echo "1. å®‰è£… [BRAT](https://github.com/TfTHacker/obsidian42-brat) æ’ä»¶" >> release_notes.md
          echo "2. æ·»åŠ æ­¤ä»“åº“ï¼š\`${{ github.repository }}\`" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version_name.outputs.VERSION_NAME }}
          body_path: release_notes.md
          files: |
            main.js
            manifest.json
            styles.css
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        run: |
          echo "âœ… Release ${{ steps.version_name.outputs.VERSION_NAME }} created successfully!"
          echo "ðŸ”— View at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}"
